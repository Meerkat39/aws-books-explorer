**概要**

- **目的**: AWS SAM を使ってローカルで作成した Node.js Lambda をデプロイし、API Gateway 経由で Google Books API をプロキシするハンズオンを実施した記録。
- **日付**: 2025-11-23
- **ファイル**: `backend/lambda/index.js`, `backend/lambda/run_test.js`, `backend/lambda/package.json`, `template.yaml`

**実行した主な作業（ステップ）**

1. ローカルで Lambda ハンドラの実装と動作確認

   - ファイル: `backend/lambda/index.js`（Google Books API を fetch して簡易に成形して返す）
   - ローカル実行コマンド（dotenv があれば自動読み込み）:
     ```bash
     node backend/lambda/run_test.js
     ```
   - 学び: `process.env.GOOGLE_BOOKS_API_KEY` があると API キーを付与するように実装しているため、ローカルでは `.env` を使って簡易検証した。

2. SAM テンプレート作成とビルド準備

   - 追加/更新したファイル: `template.yaml`（`CodeUri: backend/lambda` を設定、`Handler` を `index.handler` に修正）
   - Lambda フォルダに最小の `package.json` を追加（SAM の NodejsNpmBuilder が `name` と `version` を要求するため）。
   - 実行コマンド:
     ```bash
     sam build
     ```
   - 発生した問題と対応:
     - 初回 `sam build` で `npm error Invalid package, must have name and version` が出た → `backend/lambda/package.json` を追加して解決。

3. SAM デプロイ（CloudFormation 経由）

   - 実行コマンド（ガイド付き）:
     ```bash
     sam deploy --guided --profile dev
     ```
   - プロンプトでの主な選択:
     - Stack Name: `aws-books-explorer`
     - Region: `ap-northeast-1`（東京）
     - Confirm changes before deploy: `Y`
     - Allow SAM CLI IAM role creation: `Y`
     - BooksFunction has no authentication: テストのため `y` を選択してデプロイを進めた（注意: 公開 API になる）
   - 成果: スタック作成後に `ApiUrl` が出力され、API エンドポイントが利用可能になった。
     - 例: `https://3gbsky53hh.execute-api.ap-northeast-1.amazonaws.com/Prod/books`

4. AWS CLI / プロファイル設定

   - IAM ユーザーをコンソールで作成し、`aws configure --profile dev` でアクセスキーを登録。
   - 動作確認コマンド:
     ```bash
     aws sts get-caller-identity --profile dev
     ```

5. Git Bash での SAM 実行に関するトラブルシュート
   - 問題: Git Bash で `sam` が見つからない (`bash: sam: command not found`)。
   - 対応: Windows の `sam.cmd` を呼ぶラッパーを `~/.bashrc` に追加:
     ```bash
     sam() { cmd.exe /C "sam.cmd $*"; }
     source ~/.bashrc
     ```

**主要なコマンド一覧（手順の再現用）**

- ローカルテスト（dotenv 使用）:
  ```bash
  node backend/lambda/run_test.js
  ```
- SAM ビルド:
  ```bash
  sam build
  ```
- SAM デプロイ（ガイド付き）:
  ```bash
  sam deploy --guided --profile dev
  ```
- スタック出力の取得:
  ```bash
  aws cloudformation describe-stacks --stack-name aws-books-explorer --profile dev --region ap-northeast-1 --query 'Stacks[0].Outputs' --output table
  ```

**実行結果の要約**

- `sam build` 成功 → `.aws-sam/build` にアーティファクト生成
- `sam deploy --guided` 成功 → CloudFormation スタック `aws-books-explorer` 作成
- 取得した API URL: `https://3gbsky53hh.execute-api.ap-northeast-1.amazonaws.com/Prod/books`

**問題点・ハマりどころと対処**

- Git Bash で `sam` が見つからない: Windows の `sam.cmd` を呼ぶラッパー関数で解決。
- `npm` エラー（パッケージ情報不足）: `package.json` を `backend/lambda` に追加して解決。
- 秘密情報の扱い: ローカルに `.env` を置いて検証したが、`.env` はリポジトリに含めないこと（すでに `.env.example` を用意）。もし `.env` を誤ってコミットしていたらキーをローテートする必要あり。

**今日学んだこと（短いメモ）**

- SAM は内部で CloudFormation を使うので、実際にリソースを作ると課金対象になる点に注意。
- SAM の Node ビルドは `package.json` の `name`/`version` が必須。
- 開発環境（Git Bash）で Windows 実行ファイルを使う場合はラッパーや PATH の調整が必要。

**困った点と対処**

- 問題: `BooksFunction has no authentication`（公開 API になってしまう） — 対処: テスト段階では許可したが、本番利用時は API Key/Cognito 等で保護する。
- 問題: `.env` に API キーを置いてしまっている（ローカル） — 対処: リポジトリに含めない、Secrets Manager へ移行を計画。

**次回の課題（優先順位付き）**

1. Secrets Manager に `GOOGLE_BOOKS_API_KEY` を移し、Lambda が起動時に Secrets を読み取るように `template.yaml` を更新する（IAM ポリシー追加含む）。
2. API の公開制御: API Gateway に API Key + Usage Plan を追加、もしくは Cognito で SPA 向けに認証をつける。まずは簡易保護を追加する予定。
3. 最小権限での IAM ポリシー整備（現状は開発用に広めの権限を付与した可能性があるので整理）。
4. ミニ SPA（静的 HTML/JS）を作り、デプロイ済み API を呼ぶ。CORS の確認と簡易 UI を実装。
5. CI（GitHub Actions）で lint/test とマージ時のデプロイ（本番はステージングを経由）を整備。

**学習メモの保存場所とルール**

- ファイル: `docs/learning_notes/2025-11-23_SAM学習メモ.md`（このファイル）
- ルール: `docs/rules/learning-notes-guide.md` に従って作成済み。次回以降も同ガイドに従うこと。

**参考リンク**

- SAM deploy guide: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli.html
- AWS Pricing: https://aws.amazon.com/pricing/

---
